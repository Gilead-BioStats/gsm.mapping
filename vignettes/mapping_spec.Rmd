---
title: "Mapping Specifications"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Mapping Specifications}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

# Mapping Workflows

Currently, there exist 14 domains that have respective workflows that require mapping from source/raw data:

-   AE
-   COUNTRY
-   DATACHG
-   DATAENT
-   ENROLL
-   LB
-   PD
-   PK
-   QUERY
-   SDRGCOMP
-   SITE
-   STUDCOMP
-   STUDY
-   SUBJ

Each of the above 14 domains generally map directly 1-to-1 from a raw source, except `COUNTRY` which relies on the same dataset as `SUBJ`. The following variables/types from their respective domains is **REQUIRED** in the source/raw data:

```{r raw, echo = FALSE, message = FALSE, error = FALSE}
library(DT)
library(gsm)
library(gsm.mapping)
library(gsm.datasim)
library(dplyr)

core_mappings <- c("AE", "COUNTRY", "DATACHG", "DATAENT", "ENROLL", "LB",
                   "PD", "PK", "QUERY", "STUDY", "STUDCOMP", "SDRGCOMP", "SITE", "SUBJ")

basic_sim <- gsm.datasim::generate_rawdata_for_single_study(
  SnapshotCount = 1,
  SnapshotWidth = "months",
  ParticipantCount = 30,
  SiteCount = 5,
  StudyID = "ABC",
  workflow_path = "workflow/1_mappings",
  mappings = core_mappings,
  package = "gsm.mapping",
  desired_specs = NULL
)

lSource <- basic_sim[[1]]

lRaw <- list(
  Raw_SUBJ = lSource$Raw_SUBJ,
  Raw_AE = lSource$Raw_AE,
  Raw_PD = lSource$Raw_PD %>%
    rename(subjid = subjectenrollmentnumber),
  Raw_LB = lSource$Raw_LB,
  Raw_STUDCOMP = lSource$Raw_STUDCOMP %>%
    select(subjid, compyn),
  Raw_SDRGCOMP = lSource$Raw_SDRGCOMP,
  Raw_DATACHG = lSource$Raw_DATACHG %>%
    rename(subject_nsv = subjectname),
  Raw_DATAENT = lSource$Raw_DATAENT %>%
    rename(subject_nsv = subjectname),
  Raw_QUERY = lSource$Raw_QUERY %>%
    rename(subject_nsv = subjectname),
  Raw_ENROLL = lSource$Raw_ENROLL,
  Raw_SITE = lSource$Raw_SITE %>%
    rename(studyid = protocol) %>%
    rename(invid = pi_number) %>%
    rename(InvestigatorFirstName = pi_first_name) %>%
    rename(InvestigatorLastName = pi_last_name) %>%
    rename(City = city) %>%
    rename(State = state) %>%
    rename(Country = country) %>%
    rename(Status = site_status),
  Raw_STUDY = lSource$Raw_STUDY %>%
    rename(studyid = protocol_number) %>%
    rename(Status = status),
  Raw_PK = lSource$Raw_PK
)


# Step 1 - Create Mapped Data Layer - filter, aggregate and join raw data to create mapped data layer
mappings_wf <- MakeWorkflowList(strName = core_mappings, strPath = "workflow/1_mappings", strPackage = "gsm.mapping")
mapped <- RunWorkflows(mappings_wf, lRaw)

# Extract the nested variables and their types correctly
raw_result <- lapply(names(mappings_wf), function(domain_name) {
  domain <- mappings_wf[[domain_name]]$spec
  do.call(rbind, lapply(names(domain), function(var_name) {
    variables <- domain[[var_name]]
    data.frame(
      Domain = domain_name,
      Source_Variable = sapply(seq_along(variables), function(i) ifelse(is.null(variables[[i]]$source_col), 
                                                                        names(variables)[i], 
                                                                        variables[[i]]$source_col)
                        ),
      Mapped_Variable = names(variables),
      Type = sapply(variables, function(var) var$type),
      stringsAsFactors = FALSE
    )
  }))
})
# Combine all domains into one table
raw_final_table <- do.call(rbind, raw_result)
row.names(raw_final_table) <- NULL
raw_final_table %>%
    DT::datatable(
      extensions = 'FixedColumns',
      options = list(
        scrollX = FALSE,
        fixedColumns = TRUE
      ),
      rownames = FALSE
    )
```
